name: Build & Release Songbook PDF (REST)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build PDF in CentOS Stream 9
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace quay.io/centos/centos:stream9 /bin/bash -c "
            dnf -y update && \
            dnf -y install texlive-latex texlive-collection-fontsrecommended texlive-fancyhdr texlive-epstopdf-pkg && \
            cd /workspace && \
            pdflatex pack-showbook_letter_full_page.tex && \
            pdflatex pack-showbook_letter_full_page.tex && \
            pdflatex songbook_halfpage.tex && \
            pdflatex songbook_halfpage.tex && \
            dnf -y install texlive-pdfpages texlive-pdflscape && \
            mkdir -p ~/texmf/tex/latex/everyshi && \
            curl -L -o ~/texmf/tex/latex/everyshi/everyshi.sty https://mirrors.ctan.org/macros/latex/contrib/everyshi/everyshi.sty && \
            texhash ~/texmf && \
            cd ~/ && \
            dnf -y install git wget && \
            wget https://github.com/pdfjam/pdfjam/releases/download/v4.2/pdfjam-4.2.tar.gz && \
            tar zxvf pdfjam-4.2.tar.gz && \
            mkdir -p ~/code/ && \
            cd ~/code/ && \
            git clone https://github.com/pdfjam/pdfjam-extras && \
            export PATH=~/pdfjam-4.2/bin:$PATH && \
            ~/code/pdfjam-extras/bin/pdfbook --short-edge /workspace/songbook_halfpage.pdf  --outfile /workspace/songbook_half_booklet.pdf
          "

      - name: Install jq (parse JSON)
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Generate release tag
        id: tag
        run: |
          TAG="$(TZ='America/Chicago' date +%Y%m%d-%H%M%S)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create release (REST) and upload PDF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ steps.tag.outputs.tag }}
          ASSET_PATH: ${{ github.workspace }}/pack-showbook_letter_full_page.pdf
        run: |
          set -euo pipefail

          if [ ! -f "$ASSET_PATH" ]; then
            echo "ERROR: asset not found at $ASSET_PATH"
            exit 1
          fi

          echo "Creating release for tag: $TAG"

          # Create release
          create_http_code=$(curl -sS -o /tmp/release_create.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases" \
            -d "{\"tag_name\":\"${TAG}\",\"name\":\"${TAG}\",\"draft\":false,\"prerelease\":false}")

          if [ "$create_http_code" = "201" ]; then
            echo "Release created (201)."
            upload_url=$(jq -r .upload_url /tmp/release_create.json)
          elif [ "$create_http_code" = "422" ]; then
            # Release likely exists â€” fetch release by tag
            echo "Release already exists (422). Fetching release by tag..."
            resp=$(curl -sS -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")
            upload_url=$(echo "$resp" | jq -r .upload_url)
            if [ "$upload_url" = "null" ] || [ -z "$upload_url" ]; then
              echo "ERROR: could not get upload_url for existing release."
              echo "Response:"
              echo "$resp"
              exit 1
            fi
          else
            echo "Failed to create release (HTTP $create_http_code). Response:"
            cat /tmp/release_create.json
            exit 1
          fi

          # upload_url is templated like: "https://uploads.github.com/ ... /assets{?name,label}"
          upload_url="${upload_url%\{*}"
          filename=$(basename "$ASSET_PATH")
          echo "Uploading $filename to release..."

          # Upload first PDF
          curl --fail -sS -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/pdf" \
            --data-binary @"${ASSET_PATH}" \
            "${upload_url}?name=${filename}"

          # Upload second PDF
          SECOND_ASSET_PATH="${GITHUB_WORKSPACE}/songbook_halfpage.pdf"
          if [ ! -f "$SECOND_ASSET_PATH" ]; then
            echo "ERROR: asset not found at $SECOND_ASSET_PATH"
            exit 1
          fi

          curl --fail -sS -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/pdf" \
            --data-binary @"${SECOND_ASSET_PATH}" \
            "${upload_url}?name=$(basename "$SECOND_ASSET_PATH")"

          # Upload third PDF
          THIRD_ASSET_PATH="${GITHUB_WORKSPACE}/songbook_half_booklet.pdf"
          if [ ! -f "$THIRD_ASSET_PATH" ]; then
            echo "ERROR: asset not found at $THIRD_ASSET_PATH"
            exit 1
          fi

          curl --fail -sS -X POST \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Content-Type: application/pdf" \
            --data-binary @"${THIRD_ASSET_PATH}" \
            "${upload_url}?name=$(basename "$THIRD_ASSET_PATH")"

          echo "Upload complete. Release tag: ${TAG}"
